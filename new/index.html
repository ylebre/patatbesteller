<!DOCTYPE HTML>
<html>
	<head>
		<title>Patatbesteller</title>
		<!-- meta name="viewport" content="width=device-width,height=device-height,user-scalable=no" --> 
		<meta name="viewport" content="width=device-width">
		<link rel="stylesheet" href="jquery/jquery-ui.css">
		<script type="text/javascript" src="muze.js"></script>
		<script type="text/javascript" src="event.js"></script>
		<script src="jquery/jquery-1.8.2.js"></script>
		<script src="jquery/jquery-ui.js"></script>
		<script type="text/javascript">
			muze.namespace("muze.patatbesteller");

			muze.patatbesteller = function() {
				var baseUrl = "http://patat.muze.nl/";
				var apiUrl = baseUrl + "api2/";
				var currentUser = "yvo";

				var createRequest = function(apiCall) {
					return apiUrl + apiCall + "?user=" + currentUser;
				}
				var getDescription = function(items) {
					var description = '';
					for (var i=0; i<items.length; i++) {
						description += items[i].description + ", ";
					}
					description = description.substring(0, description.length - 2);
					return description;
				}

				var getPrevious = function() {
					var myUrl = createRequest("meestbesteld.pl");
					var result = muze.load(myUrl, true, false);
					var meestBesteld = eval('(' + result + ')');
					return meestBesteld;
				}

				var getOtherPrevious = function(otherUser) {
					var myUrl = apiUrl + "meestbesteld.pl?user=" + otherUser;
					var result = muze.load(myUrl, true, false);
					var meestBesteld = eval('(' + result + ')');
					return meestBesteld;
				}

				var getCurrentOrder = function() {
					var myUrl = createRequest("besteld.pl");
					var result = muze.load(myUrl, true, false);
					var order = eval('(' + result + ')');
					return order;
				}

				var getUserList = function() {
					var myUrl = apiUrl + "userlist.pl";
					var result = muze.load(myUrl, true, false);
					var userlist = eval('(' + result + ')');
					return userlist;
				}

				var getOrderOverview = function() {
					var myUrl = apiUrl + "overzicht.pl";
					var result = muze.load(myUrl, true, false);
					var orders = eval('(' + result + ')');
					return orders;
				}

				var getCurrentOrderText = function() {
					var currentOrder = getCurrentOrder();
					if (currentOrder.length) {
						orderText = "Je hebt besteld:<br>";
						for (var i=0; i<currentOrder.length; i++) {
							orderText += "- " + currentOrder[i].description + " (&euro; " + currentOrder[i].price + ")<br>";
						}
					}
					return orderText;
				}

				var removeOrder = function() {
					// FIXME: bestel.pl moet naar het api-formaat worden omgeschreven 
					var myUrl = baseUrl + "bestel.pl";
					myUrl += "?userlist=" + currentUser;
					myUrl += "&Annuleer%20bestelling=1"
					var result = muze.load(myUrl, true, false);
				}

				var placeOrder = function(orderItems) {
					if (orderItems.length == 0) {
						return false;
					}

					var myUrl = baseUrl + "bestel.pl";
					myUrl += "?userlist=" + currentUser;
					myUrl += "&Bestel=1";
		
					for (var i=0; i<orderItems.length; i++) {
						myUrl += "&bestelling=" + orderItems[i].id;
					}

					var result = muze.load(myUrl, true, false);
				}

				var placeOtherOrder = function(orderItems, otherUser) {
					if (orderItems.length == 0) {
						return false;
					}

					var myUrl = baseUrl + "bestel.pl";
					myUrl += "?userlist=" + otherUser;
					myUrl += "&Bestel=1";
		
					for (var i=0; i<orderItems.length; i++) {
						myUrl += "&bestelling=" + orderItems[i].id;
					}

					var result = muze.load(myUrl, true, false);
				}

				var getOrderOptions = function() {
					var myUrl = apiUrl + "menu.pl?user=" + currentUser;
					var result = muze.load(myUrl, true, false);
					var orderOptions = eval('(' + result + ')');
					return orderOptions;
				}

				var showComposeOrder = function() {
					hidePages();
					populateOrderOptions();
					document.getElementById("composeOrderPage").style.display = "block";
				}

				var hidePages = function() {
					var pages = document.getElementById("content").childNodes;
					for (var i=0; i<pages.length; i++) {
						if (pages[i].className && pages[i].className.match(/\bpage\b/)) {
							pages[i].style.display = "none";
						}
					}
				}

				var hideComposeOrder = function() {
					document.getElementById("composeOrderPage").style.display = "none";
				}

				var populateOrderOverview = function() {
					var orders = getOrderOverview();
					var orderOverview = document.getElementById("orderOverview");
					var ordersByPerson = document.getElementById("ordersByPerson");

					orderOverview.innerHTML = '';
					ordersByPerson.innerHTML = '';

					for (var i=0; i<orders.cumulatief.length; i++) {
						var orderLine = document.createElement("DIV");
						orderLine.className = "orderLine";
						orderLine.innerHTML = orders.cumulatief[i].amount + " x " + orders.cumulatief[i].description;
						orderLine.innerHTML += "<span class='price'>&euro; " + orders.cumulatief[i].itemtotal + "</span>";
						orderLine.innerHTML += "<br><span class='itemprice'>a &euro; " + orders.cumulatief[i].price + "</span>";

						orderOverview.appendChild(orderLine);
					}

					orderTotal = document.createElement("DIV");
					orderTotal.className = "orderLine total";
					orderTotal.innerHTML = "Totaal: <span class='price'>&euro; " + orders.total + "</span>";
					orderOverview.appendChild(orderTotal);

					for (var i=0; i<orders.wie_eet_wat.length; i++) {
						var orderLine = document.createElement("DIV");
						orderLine.className = "orderLine";
						orderLine.innerHTML = orders.wie_eet_wat[i].user;
						orderLine.innerHTML += "<span class='price'>&euro; " + orders.wie_eet_wat[i].usertotal + "</span>";
						orderLine.innerHTML += "<br><span class='order'>" + getDescription(orders.wie_eet_wat[i].bestelling) + "</span>";

						ordersByPerson.appendChild(orderLine);
					}

					orderTotal = document.createElement("DIV");
					orderTotal.className = "orderLine total";
					orderTotal.innerHTML = "Totaal: <span class='price'>&euro; " + orders.total + "</span>";
					ordersByPerson.appendChild(orderTotal);
				}

				var showOverview = function() {
					hidePages();
					showOrderOverview();
					populateOrderOverview();
					document.getElementById("orderOverviewPage").style.display = "block";
				}

				var showOrderOverview = function() {
					hideOrdersByPerson();
					document.getElementById("orderOverview").style.display = "block";
			
				}
				var hideOrderOverview = function() {
					document.getElementById("orderOverview").style.display = "none";
				}

				var hideOrdersByPerson = function() {
					document.getElementById("ordersByPerson").style.display = "none";
				}

				var showOrdersByPerson = function() {
					hideOrderOverview();
					document.getElementById("ordersByPerson").style.display = "block";
				}

				var populateOrderOptions = function() {
					var orderOptions = getOrderOptions();
					var orderFormOptions = document.getElementById("orderFormOptions");
					orderFormOptions.innerHTML = '';

					for (var i=0; i<orderOptions.length; i++) {
						var orderCheckbox = document.createElement("INPUT");
						orderCheckbox.type = "checkbox";
						orderCheckbox.value = orderOptions[i].id;
						orderCheckbox.name = "bestelling";
						orderCheckbox.id = "orderOption" + orderOptions[i].id;

						var orderLabel = document.createElement("LABEL");
						orderLabel.setAttribute("for", orderCheckbox.id);
						orderLabel.className = "orderOption";

						var orderTitle = document.createElement("DIV");
						orderTitle.className = "title";
						orderTitle.innerHTML = orderOptions[i].description;

						var orderPrice = document.createElement("DIV"); 
						orderPrice.innerHTML = "&euro; " + orderOptions[i].price;
						orderLabel.appendChild(orderCheckbox);
						orderLabel.appendChild(orderTitle);
						orderLabel.appendChild(orderPrice);
						orderFormOptions.appendChild(orderLabel);
					}
				}

				var handleRemoveOrder = function() {
					removeOrder();
					showPlaceOrderPage();
				}

				var getCheckedItems = function() {
					var orderOptions = document.getElementById("orderFormOptions").getElementsByTagName("input");
					var orderItems = new Array();

					for (var i=0; i<orderOptions.length; i++) {
						if (orderOptions[i].checked) {
							var orderItem = {
								id : orderOptions[i].value
							}
							orderItems.push(orderItem);
						}
					}

					return orderItems;
				}

				var handleOrderForm = function(event) {
					var orderItems = getCheckedItems();
					muze.event.preventDefault(event);
					placeOrder(orderItems);
					muze.patatbesteller.init();
				}

				var repeatFrequentOrder = function() {
				}
				var repeatLastOrder = function() {
				}

				var populateOrderButtons = function() {
					var meestBesteld = getPrevious();

					document.getElementById("lastOrder").innerHTML = getDescription(meestBesteld.laatst);
					document.getElementById("frequentOrder").innerHTML = getDescription(meestBesteld.meest);

					repeatLastOrder = function() {
 						placeOrder(meestBesteld.laatst);
 						showOrderedPage();
					}
					repeatFrequentOrder = function() {
						placeOrder(meestBesteld.meest);
						showOrderedPage();
					}
				}

				var populateOtherOrderButtons = function() {
					var otherUser = document.getElementById("otherUser").value;
					
					var meestBesteld = getOtherPrevious(otherUser);

					document.getElementById("otherLastOrder").innerHTML = getDescription(meestBesteld.laatst);
					document.getElementById("otherFrequentOrder").innerHTML = getDescription(meestBesteld.meest);

					repeatOtherLastOrder = function() {
 						placeOtherOrder(meestBesteld.laatst, otherUser);
						showOrderedPage();
					}
					repeatOtherFrequentOrder = function() {
						placeOtherOrder(meestBesteld.meest, otherUser);
						showOrderedPage();
					}
				}

				var showPlaceOrderPage = function() {
					hidePages();
					populateOrderButtons();
					document.getElementById("welcomeText").innerHTML = "Hallo " + currentUser + ",<br>Wat wil je vandaag eten?";
					document.getElementById("placeOrderPage").style.display = "block";
				}

				var showOrderedPage = function() {
					hidePages();
					document.getElementById("currentOrder").innerHTML = "Hallo " + currentUser + ",<br>" + getCurrentOrderText();
					document.getElementById("orderedPage").style.display = "block";
				}

				var populateUserAutoComplete = function() {
					var userlist = getUserList();
					$("#otherUser").autocomplete({
						source: userlist
					});				
				}

				var showPlaceOtherOrderPage = function() {
					hidePages();
					populateUserAutoComplete();
					document.getElementById("placeOtherOrderPage").style.display = "block";
					document.getElementById("otherUser").value = '';
					document.getElementById("otherUser").focus();
				}

				var showComposeOtherOrder = function() {
					currentUser = document.getElementById("otherUser").value;
					showComposeOrder();
				}

				return {
					init : function() {
						var currentOrder = getCurrentOrder();
						if (currentOrder.length) {
							showOrderedPage();
						} else {
							showPlaceOrderPage();
						}
					},
					attachButtonEvents : function() {
						muze.event.attach(document.getElementById("removeOrder"), "click", handleRemoveOrder);
						muze.event.attach(document.getElementById("repeatLastOrder"), "click", repeatLastOrder);
						muze.event.attach(document.getElementById("repeatFrequentOrder"), "click", repeatFrequentOrder);
						muze.event.attach(document.getElementById("repeatOtherLastOrder"), "click", repeatOtherLastOrder);
						muze.event.attach(document.getElementById("repeatOtherFrequentOrder"), "click", repeatOtherFrequentOrder);
						muze.event.attach(document.getElementById("composeOrder"), "click", showComposeOrder);
						muze.event.attach(document.getElementById("orderForm"), "submit", handleOrderForm);
						muze.event.attach(document.getElementById("overviewButton"), "click", showOverview);
						muze.event.attach(document.getElementById("orderOverviewButton"), "click", showOrderOverview);
						muze.event.attach(document.getElementById("ordersByPersonButton"), "click", showOrdersByPerson);
						muze.event.attach(document.getElementById("ordersByPersonButton"), "click", showOrdersByPerson);
						muze.event.attach(document.getElementById("orderForOther"), "click", showPlaceOtherOrderPage);
						muze.event.attach(document.getElementById("orderForOther2"), "click", showPlaceOtherOrderPage);
						muze.event.attach(document.getElementById("otherUser"), "change", populateOtherOrderButtons);
						muze.event.attach(document.getElementById("composeOtherOrder"), "click", showComposeOtherOrder);
						/*$('label').click(function(){
							if (this.getAttribute("for")) {
								if (document.getElementById(this.getAttribute("for")) {
									document.getElementById(this.getAttribute("for").click();
								}
							}
						});*/
					},
					hidePages : hidePages
				}
			}();

		</script>
		<script type="text/javascript">
			function isTouchDevice(){
				try{
					document.createEvent("TouchEvent");
					return true;
				}catch(e){
					return false;
				}
			}

			function touchScroll(element){
				if(isTouchDevice()){ //if touch events exist...
					var scrollStartPos=0;

					element.addEventListener("touchstart", function(event) {
						scrollStartPos=this.scrollTop+event.touches[0].pageY;
					//	event.preventDefault();
					},false);

					element.addEventListener("touchmove", function(event) {
						this.scrollTop=scrollStartPos-event.touches[0].pageY;
						event.preventDefault();
					},false);
				}
			}
		</script>
		<script type="text/javascript">
			muze.event.attach(window, "load", muze.patatbesteller.init);
			muze.event.attach(window, "load", muze.patatbesteller.attachButtonEvents);
			muze.event.attach(window, "load", function() {
				touchScroll(document.getElementById("orderFormOptions"));
				touchScroll(document.getElementById("ordersByPerson"));
				touchScroll(document.getElementById("orderOverview"));
			});
		</script>
		<style type="text/css">
			html,body {
				padding: 0px;
				margin: 0px;
			}
			a img {
				border: 0px;
			}
			body {
				font-family: helvetica;
				color: #333333;
			}
			div.content {
				margin: 0px 10px;
			}

			button {
				border: 1px solid #BBBBBB;
				background-color: #F8F8F8;
				border-radius: 3px;
				margin-bottom: 10px;
				padding: 5px;
				font-size: 0.8em;
				text-align: center;
				cursor: pointer;
				width: 100%;
			}
			button {
			   /* fallback/image non-cover color */
			   background-color: #DDDDDD; 

			   /* Safari 4+, Chrome 1-9 */
			   background-image: -webkit-gradient(linear, 0% 0%, 0% 100%, from(#F8F8F8), to(#DDDDDD));

			   /* Safari 5.1+, Mobile Safari, Chrome 10+ */
			   background-image: -webkit-linear-gradient(top, #F8F8F8, #DDDDDD); 

			   /* Firefox 3.6+ */
			   background-image: -moz-linear-gradient(top, #F8F8F8, #DDDDDD);
			 
			   /* IE 10+ */
			   background-image: -ms-linear-gradient(top, #F8F8F8, #DDDDDD);

			   /* Opera 11.10+ */
			   background-image: -o-linear-gradient(top, #F8F8F8, #DDDDDD);
			}
			label {
				font-size: 0.8em;
			}
			button .title,
			label .title {
				font-size: 140%;
			}
			#welcomeText,
			#currentOrder {
				margin-bottom: 20px;
			}
			div.header {
				margin-bottom: 20px;
				background-color: #CC0000;
				color: white;
				height: 28px;
			}
			div.header img {
				height: 24px;
			}
			div.header .logo {
				background-color: white;
				display: inline-block;
				padding-left: 10px;
				padding-right: 10px;
			}
			div.header .appname {
				float: right;
				vertical-align: middle;
				line-height: 28px;
				padding-right: 10px;
			}
			div.page {
				display: none;
			}
			
			#orderFormOptions {
				position: absolute;
				top: 40px;
				bottom: 60px;
				right: 10px;
				left: 10px;
				overflow-y: auto;
			}
			#orderForm .formButtons {
				position: absolute;
				bottom: 10px;
				height: 40px;
				left: 10px;
				right: 10px;
			}
			.orderOption {
				vertical-align: middle;
				border-bottom: 1px solid #DDDDDD;
				display: block;
			}
			.orderOption input {
				float: right;
				display: block;
				
			}
			.orderOption:nth-child(2n+1) {
				background-color: #F8F8F8;
			}
			#overviewNav button {
				width: auto;
				padding-left: 10px;
				padding-right: 10px;
				display: inline-block;
			}

			div.orderLine {
				padding-top: 4px;
				padding-bottom: 4px;
				border-bottom: 1px solid #DDDDDD;
			}
			div.orderLine.total {
				font-weight: bold;
			}
			div.orderLine:nth-child(2n+1) {
				background-color: #F8F8F8;
			}

			div.orderLine .price {
				float: right;
				margin-right: 10px;
			}
			div.orderLine .itemprice {
				font-size: 0.8em;
				margin-left: 24px;
			}
			div.orderLine .order {
				font-size: 0.8em;
			}
			#otherUser {
				margin-bottom: 10px;
			}
		</style>
	</head>
	<body>
		<div class="header">
			<div class="logo">
				<a href=""><img src="http://www.muze.nl/graphics/muze.png"></a>
			</div>
			<div class="appname">
				Patatbesteller 1.0
			</div>
		</div>
		<div id="content" class="content">
			<div id="placeOrderPage" class="page">
				<div id="welcomeText">
				</div>
				<button id="repeatLastOrder">
					<div class="title">Herhaal vorige keer</div>
					<div id="lastOrder"></div>
				</button>
				<button id="repeatFrequentOrder">
					<div class="title">Ook vaak besteld</div>
					<div id="frequentOrder"></div>
				</button>
				<button id="composeOrder">
					<div class="title">Bestelling samenstellen</div>
				</button>
				<button id="orderForOther">
					<div class="title">Bestel voor een ander</div>
				</button>
			</div>
			<div id="orderedPage" class="page">
				<div id="currentOrder">
				</div>
				<button id="removeOrder">
					<div class="title">Verwijder bestelling</div>
				</button>
				<button id="overviewButton">
					<div class="title">Overzicht bestellingen</div>
				</button>
				<button id="orderForOther2">
					<div class="title">Bestel voor een ander</div>
				</button>
			</div>
			<div id="composeOrderPage" class="page">
				<form id="orderForm" method="POST" action="">
					<div id="orderFormOptions">
					</div>
					<div class="formButtons">
						<button name="bestel" value="Plaats bestelling"><div class="title">Plaats bestelling</div></button>
					</div>
				</form>
			</div>
			<div id="orderOverviewPage" class="page">
				<div id="overviewNav">
					<button id="orderOverviewButton">
						<div class="title">Overzicht</div>
					</button>
					<button id="ordersByPersonButton">
						<div class="title">Wie eet wat</div>
					</button>
				</div>
				<div id="orderOverview">
				</div>
				<div id="ordersByPerson">
				</div>
			</div>
			<div id="placeOtherOrderPage" class="page">
				<div class="ui-widget">
					<label for="otherUser">Bestel voor:</label>
					<input id="otherUser">
				</div>
				<button id="repeatOtherLastOrder">
					<div class="title">Herhaal vorige keer</div>
					<div id="otherLastOrder"></div>
				</button>
				<button id="repeatOtherFrequentOrder">
					<div class="title">Ook vaak besteld</div>
					<div id="otherFrequentOrder"></div>
				</button>
				<button id="composeOtherOrder">
					<div class="title">Bestelling samenstellen</div>
				</button>
			</div>
		</div>
	</body>
</html>	